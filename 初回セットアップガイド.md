# 初回セットアップガイド

このドキュメントは、CME FedWatch データ取得ツールを初めて使う方向けの完全なセットアップ手順です。

## 📋 前提条件

以下の環境が必要です：
- **macOS** （自動実行機能を使用する場合）
- **Python 3.8以上** がインストールされていること
- **インターネット接続** が利用できること
- **Googleアカウント** と **Google Cloud Project** へのアクセス権限

## 🚀 ステップ1: プロジェクトの取得

### オプションA: Git リポジトリからクローン（推奨）

```bash
git clone https://github.com/yousunafu/CME.git
cd CME
```

### オプションB: ZIPファイルで取得した場合

1. ZIPファイルを解凍
2. ターミナルでそのディレクトリに移動
3. 適切な場所に配置（例: `~/Documents/CME`）

## 🔧 ステップ2: Python環境のセットアップ

### 2-1. 仮想環境の作成（推奨）

```bash
# プロジェクトディレクトリに移動
cd /path/to/CME

# 仮想環境を作成
python3 -m venv venv

# 仮想環境を有効化
source venv/bin/activate
```

### 2-2. 必要なライブラリのインストール

```bash
# requirements.txtから一括インストール
pip install -r requirements.txt

# Playwrightブラウザのインストール
playwright install chromium
```

個別にインストールする場合：

```bash
pip install gspread google-auth playwright
playwright install chromium
```

## 🔑 ステップ3: Googleスプレッドシートの設定

### 3-1. Google Cloud Project の準備

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成、または既存のプロジェクトを選択
3. プロジェクト名を覚えておく（例: "CME Scraper"）

### 3-2. Google Sheets API の有効化

1. プロジェクト選択後、左メニューから **「APIとサービス」→「ライブラリ」** を選択
2. 検索ボックスで「Google Sheets API」を検索
3. 「Google Sheets API」を選択して **「有効にする」** をクリック
4. 同様に「Google Drive API」も有効にする

### 3-3. サービスアカウントの作成

1. 左メニューから **「APIとサービス」→「認証情報」** を選択
2. 上部の **「認証情報を作成」→「サービスアカウント」** を選択
3. サービスアカウント名を入力（例: "cme-scraper"）
4. **「作成して続行」** をクリック
5. ロールは **「編集者」** または **「オーナー」** を選択（またはスキップ）
6. **「完了」** をクリック

### 3-4. 認証キーのダウンロード

1. 作成したサービスアカウントをクリック
2. **「キー」** タブを選択
3. **「キーを追加」→「新しいキーを作成」** を選択
4. キーのタイプで **「JSON」** を選択
5. **「作成」** をクリック → JSONファイルが自動的にダウンロードされる

### 3-5. 認証キーファイルの配置

1. ダウンロードしたJSONファイルを `service_account.json` という名前に変更
2. このファイルを `main.py` と同じディレクトリに配置
   ```bash
   # 例：ダウンロードフォルダから移動
   mv ~/Downloads/your-project-xxxxx.json ~/Documents/CME/service_account.json
   ```

**⚠️ 重要：** このファイルには機密情報が含まれています。他人と共有しないでください。

### 3-6. スプレッドシートの作成と共有設定

1. [Googleスプレッドシート](https://sheets.google.com/) を開く
2. 新しいスプレッドシートを作成
3. スプレッドシートの名前を **「CME定期調査」** に変更
   - ⚠️ 注意：`main.py` 内で `gc.open("CME定期調査")` としてこの名前を参照しています
4. 右上の **「共有」** ボタンをクリック
5. ステップ3-3で作成したサービスアカウントのメールアドレス（例: `cme-scraper@your-project.iam.gserviceaccount.com`）を入力
6. 権限を **「編集者」** に設定
7. **「送信」** をクリック

**💡 ヒント：** サービスアカウントのメールアドレスは、Google Cloud Console の「認証情報」ページで確認できます。

## ✅ ステップ4: 動作確認

### 4-1. 手動実行でテスト

```bash
# プロジェクトディレクトリに移動
cd /path/to/CME

# 仮想環境を有効化（まだ有効化していない場合）
source venv/bin/activate

# スクリプトを実行
python main.py
```

正常に動作する場合：
- ブラウザが起動する（`headless=False` の場合）
- CME FedWatchのページが開く
- データが取得され、Googleスプレッドシートに書き込まれる

### 4-2. スプレッドシートの確認

1. Googleスプレッドシート「CME定期調査」を開く
2. データが正しく書き込まれているか確認
3. 「前回値」というシートが自動作成されているか確認

## ⚙️ ステップ5: 自動実行の設定（オプション）

macOSで自動実行を設定する場合は、`自動化セットアップ手順.md` を参照してください。

ただし、その前に以下を確認してください：

1. `com.cme.scraper.plist` ファイル内のパスを自分の環境に合わせて編集
   - 例：`/Users/suzukiyuu/Desktop/CME` → `/Users/yourname/Documents/CME`

## 🔍 トラブルシューティング

### エラー: `認証ファイルが見つかりません`

**原因：** `service_account.json` が正しい場所に配置されていない

**解決方法：**
```bash
# 現在のディレクトリを確認
pwd

# service_account.json が存在するか確認
ls -la service_account.json

# 存在しない場合、正しい場所にコピー
cp ~/Downloads/service_account.json .
```

### エラー: `スプレッドシートが見つかりません`

**原因：** スプレッドシート名が一致していない、またはサービスアカウントに共有されていない

**解決方法：**
1. スプレッドシート名が **「CME定期調査」** であることを確認
2. サービスアカウントのメールアドレスで共有されているか確認
3. 共有設定で権限が「編集者」以上であることを確認

### エラー: `Permission denied` または認証エラー

**原因：** サービスアカウントのキーが正しくない、またはAPIが有効化されていない

**解決方法：**
1. Google Cloud Console で「Google Sheets API」と「Google Drive API」が有効化されているか確認
2. JSONキーファイルが正しくダウンロードされたか確認
3. 新しいキーを再作成してみる

### エラー: ブラウザが起動しない

**原因：** Playwrightブラウザが正しくインストールされていない

**解決方法：**
```bash
# 仮想環境を有効化
source venv/bin/activate

# Playwrightブラウザを再インストール
playwright install chromium

# または、Firefoxをインストール
playwright install firefox
```

### その他のエラー

詳細なエラーログを確認するには：

```bash
# エラーログを確認
tail -f logs/error.log

# 出力ログを確認
tail -f logs/output.log
```

## 📞 サポート

問題が解決しない場合は、以下の情報とともに連絡してください：

1. 実行したコマンド
2. エラーメッセージの全文
3. Python バージョン（`python3 --version`）
4. オペレーティングシステムのバージョン（`sw_vers` for macOS）
